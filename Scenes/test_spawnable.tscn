[gd_scene load_steps=2 format=3 uid="uid://chmp2sp242nx4"]

[sub_resource type="GDScript" id="GDScript_wt6tw"]
script/source = "extends CompositeNodeModule

var _U8_value : CompositeNodeValue
var _U16_value : CompositeNodeValue
var _U32_value : CompositeNodeValue
var _U64_value : CompositeNodeValue
var _S8_value : CompositeNodeValue
var _S16_value : CompositeNodeValue
var _S32_value : CompositeNodeValue
var _S64_value : CompositeNodeValue
var _HalfFloat_value : CompositeNodeValue
var _Float_value : CompositeNodeValue
var _Double_value : CompositeNodeValue
var _Vector2Type_value : CompositeNodeValue
var _Vector3Type_value : CompositeNodeValue

var _next_update_gametime : float

# Called when the node enters the scene tree for the first time.
func _ready_composite_node() -> void:
	_U8_value = create_synchronized_value(&\"U8_value\", 0, CompositeNode.HighFrequency, CompositeNode.U8)
	_U16_value = create_synchronized_value(&\"U16_value\", 0, CompositeNode.LowFrequency, CompositeNode.U16)
	_U32_value = create_synchronized_value(&\"U32_value\", 0, CompositeNode.OnChange, CompositeNode.U32)
	_U64_value = create_synchronized_value(&\"U64_value\", 0, CompositeNode.OnChange, CompositeNode.U64)
	_S8_value = create_synchronized_value(&\"S8_value\", 0, CompositeNode.OnChange, CompositeNode.S8)
	_S16_value = create_synchronized_value(&\"S16_value\", 0, CompositeNode.OnChange, CompositeNode.S16)
	_S32_value = create_synchronized_value(&\"S32_value\", 0, CompositeNode.OnChange, CompositeNode.S32)
	_S64_value = create_synchronized_value(&\"S64_value\", 0, CompositeNode.OnChange, CompositeNode.S64)
	_HalfFloat_value = create_synchronized_value(&\"HalfFloat_value\", 0, CompositeNode.OnChange, CompositeNode.HalfFloat)
	_Float_value = create_synchronized_value(&\"Float_value\", 0, CompositeNode.OnChange, CompositeNode.Float)
	_Double_value = create_synchronized_value(&\"Double_value\", 0, CompositeNode.OnChange, CompositeNode.Double)
	_Vector2Type_value = create_synchronized_value(&\"Vector2Type_value\", 0, CompositeNode.OnChange, CompositeNode.Vector2Type)
	_Vector3Type_value = create_synchronized_value(&\"Vector3Type_value\", 0, CompositeNode.OnChange, CompositeNode.Vector3Type)
	
	var cl := _composite_node.GetCommunicationLine()
	if cl.is_server():
		print(\"Server: composite node ready \", cl.get_local_peer_bits())
	else:
		print(\"Client: composite node ready \", cl.get_local_peer_bits())
	
	cl.add_function_definition(
		&\"server_to_client_call\",
		server_to_client_call,
		[CommunicationLine.S32],
		CommunicationLine.None,
		MultiplayerPeer.TRANSFER_MODE_RELIABLE
	)
	cl.add_function_definition(
		&\"client_to_client_call\",
		client_to_client_call,
		[CommunicationLine.S32],
		CommunicationLine.None,
		MultiplayerPeer.TRANSFER_MODE_RELIABLE
	)
	
func server_to_client_call(sender_id: int, other_peer: int):
	print(\"	Recived packet from: %d \\n
			I'am: %d \\n
			Send it to: %d \\n\" % [sender_id, _composite_node.GetCommunicationLine().get_local_multiplayer_id(), other_peer])
	_composite_node.GetCommunicationLine().call_function_on_peer(&\"client_to_client_call\",[5],other_peer)

func client_to_client_call(sender_id: int, package: int):
	print(\"	Recived packet from: %d \\n
			I'am: %d \\n
			Package is: %d \\n\" % [sender_id, _composite_node.GetCommunicationLine().get_local_multiplayer_id(), package])

func _ready_authority() -> void:
	var cl := _composite_node.GetCommunicationLine()
	if cl.is_server():
		print(\"Server: authority ready \", cl.get_local_peer_bits())
	else:
		print(\"Client: authority ready \", cl.get_local_peer_bits())

# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(_delta: float) -> void:
	if _composite_node.IsServer():
		var ids := CommunicationLineSystem.get_global_communication_line_system().get_peer_ids()
		if ids.size() < 2: return
		_composite_node.GetCommunicationLine().call_function_on_peer(&\"server_to_client_call\",[ids[2]],ids[1])
		
		
	if not _composite_node.IsAuthority():
		return
	var gametime : float = GameTime.GameTime
	if gametime >= _next_update_gametime:
		while gametime >= _next_update_gametime:
			_next_update_gametime += 5

		_U8_value.value = randi_range(0, 255)
		_U16_value.value = randi_range(0, 65535)
		_U32_value.value = randi()
		_U64_value.value = randi_range(0, 1844674407370955161)
		_S8_value.value = randi_range(-128, 127)
		_S16_value.value = randi_range(-32768, 32767)
		_S32_value.value = randi_range(-2147483648, 2147483647)
		_S64_value.value = randi_range(-922337203685477580, 922337203685477580)
		_HalfFloat_value.value = randf()
		_Float_value.value = randf()
		_Double_value.value = randf()
		_Vector2Type_value.value = Vector2(randf(), randf())
		_Vector3Type_value.value = Vector3(randf(), randf(), randf())
"

[node name="Spawnable" type="CompositeNode"]

[node name="Node" type="CompositeNodeModule" parent="."]
script = SubResource("GDScript_wt6tw")
